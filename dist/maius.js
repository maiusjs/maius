"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const Debug = require("debug");
const fs = require("fs");
const path = require("path");
const application_1 = require("./lib/application");
const base_context_1 = require("./lib/base-context");
const router_1 = require("./lib/router");
const static_1 = require("./lib/static");
const controller_1 = require("./loader/controller");
const middleware_1 = require("./loader/middleware");
const service_1 = require("./loader/service");
const user_config_1 = require("./loader/user-config");
const debug = Debug('maius:maius');
const MIDDLEWARE_LOADER = Symbol('middleware_loader');
const CONTROLLER_LOADER = Symbol('controller_loader');
const SERVICE_LOADER = Symbol('service_loader');
const USER_CONFIG = Symbol('user_config');
class Maius {
    constructor(options) {
        assert(typeof options.rootDir === 'string', 'options.rootDir config error!');
        this.options = options;
        this.app = new application_1.default();
        this.router = new router_1.default({}, this);
        this.controller = this.controllerLoader.getIntancesCol();
        debug('%o %o', 'this.controller', this.controller);
        this.service = this.serviceLoader.getIntancesCol();
        debug('%o %o', 'this.service', this.service);
        this.setControllerAndServiceProps();
        this.useMiddleware();
        debug('%o %o %o', 'middleware', this.middleware, this.afterRouterMiddleware);
        this.useStatic();
        this.useRouter();
        this.useAfterRouterMiddleware();
    }
    get controllerLoader() {
        if (this[CONTROLLER_LOADER]) {
            return this[CONTROLLER_LOADER];
        }
        this[CONTROLLER_LOADER] = new controller_1.default({
            path: path.join(this.options.rootDir, 'controller'),
        });
        return this[CONTROLLER_LOADER];
    }
    get serviceLoader() {
        if (this[SERVICE_LOADER]) {
            return this[SERVICE_LOADER];
        }
        this[SERVICE_LOADER] = new service_1.default({
            path: path.join(this.options.rootDir, 'service'),
        });
        return this[SERVICE_LOADER];
    }
    get middlewareLoader() {
        if (this[MIDDLEWARE_LOADER]) {
            return this[MIDDLEWARE_LOADER];
        }
        this[MIDDLEWARE_LOADER] = new middleware_1.default(this.options);
        return this[MIDDLEWARE_LOADER];
    }
    setControllerAndServiceProps() {
        Object.keys(this.controller).forEach(key => {
            this.controller[key].bindController(this.controller);
            this.controller[key].bindService(this.service);
        });
        Object.keys(this.service).forEach(key => {
            this.service[key].bindController(this.controller);
            this.service[key].bindService(this.service);
        });
    }
    useMiddleware() {
        this.middleware.forEach(fn => {
            this.app.use(fn);
        });
    }
    useAfterRouterMiddleware() {
        this.afterRouterMiddleware.forEach(fn => {
            this.app.use(fn);
        });
    }
    useStatic() {
        const publicPath = path.join(this.options.rootDir, 'public');
        try {
            fs.readdirSync(publicPath);
        }
        catch (e) {
            return;
        }
        this.app.use(static_1.default(publicPath, this.userConfig.static));
    }
    useRouter() {
        require(path.join(this.options.rootDir, 'router.js'))({
            controller: this.controller,
            router: this.router,
        });
        this.app.use(this.router.routes());
    }
    get middleware() {
        return this.middlewareLoader.getMiddlewera().middleware;
    }
    get afterRouterMiddleware() {
        return this.middlewareLoader.getMiddlewera().afterRouterMiddleware;
    }
    get userConfig() {
        if (this[USER_CONFIG]) {
            return this[USER_CONFIG];
        }
        this[USER_CONFIG] = new user_config_1.default(this).config;
        return this[USER_CONFIG];
    }
    listen(port) {
        assert(typeof port === 'number', 'Maius.prototype.listen(port), port must be a number');
        return new Promise(resolve => {
            this.app.listen(port, () => resolve());
        });
    }
}
Maius.Controller = base_context_1.default;
Maius.Service = base_context_1.default;
exports.default = Maius;
module.exports = Maius;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsQ0FBQztTQUMxQjtRQUVELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxJQUFJLHFCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUN0RCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBV00sTUFBTSxDQUFDLElBQUk7UUFDaEIsTUFBTSxDQUNKLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFDeEIscURBQXFELENBQ3RELENBQUM7UUFFRixPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzNCLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7QUF4UGEsZ0JBQVUsR0FBRyxzQkFBVyxDQUFDO0FBQ3pCLGFBQU8sR0FBRyxzQkFBVyxDQUFDO0FBMFB0QyxrQkFBZSxLQUFLLENBQUM7QUFFckIsTUFBTSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMiLCJmaWxlIjoibWFpdXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSAnYXNzZXJ0JztcbmltcG9ydCAqIGFzIERlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnLi9saWIvYXBwbGljYXRpb24nO1xuaW1wb3J0IEJhc2VDb250ZXh0IGZyb20gJy4vbGliL2Jhc2UtY29udGV4dCc7XG5pbXBvcnQgUm91dGVyIGZyb20gJy4vbGliL3JvdXRlcic7XG5pbXBvcnQgbWFpdXNTdGF0aWMgZnJvbSAnLi9saWIvc3RhdGljJztcbmltcG9ydCBDb250cm9sbGVyTG9hZGVyIGZyb20gJy4vbG9hZGVyL2NvbnRyb2xsZXInO1xuaW1wb3J0IE1pZGRsZXdhcmVMb2FkZXIgZnJvbSAnLi9sb2FkZXIvbWlkZGxld2FyZSc7XG5pbXBvcnQgU2VydmljZUxvYWRlciBmcm9tICcuL2xvYWRlci9zZXJ2aWNlJztcbmltcG9ydCBVc2VyQ29uZmlnTG9hZGVyIGZyb20gJy4vbG9hZGVyL3VzZXItY29uZmlnJztcblxuY29uc3QgZGVidWcgPSBEZWJ1ZygnbWFpdXM6bWFpdXMnKTtcblxuY29uc3QgTUlERExFV0FSRV9MT0FERVIgPSBTeW1ib2woJ21pZGRsZXdhcmVfbG9hZGVyJyk7XG5jb25zdCBDT05UUk9MTEVSX0xPQURFUiA9IFN5bWJvbCgnY29udHJvbGxlcl9sb2FkZXInKTtcbmNvbnN0IFNFUlZJQ0VfTE9BREVSID0gU3ltYm9sKCdzZXJ2aWNlX2xvYWRlcicpO1xuY29uc3QgVVNFUl9DT05GSUcgPSBTeW1ib2woJ3VzZXJfY29uZmlnJyk7XG5cbmludGVyZmFjZSBJT3B0aW9ucyB7XG4gIHJvb3REaXI6IHN0cmluZztcbiAgcG9ydD86IG51bWJlcjtcbn1cblxuY2xhc3MgTWFpdXMge1xuICBwdWJsaWMgc3RhdGljIENvbnRyb2xsZXIgPSBCYXNlQ29udGV4dDtcbiAgcHVibGljIHN0YXRpYyBTZXJ2aWNlID0gQmFzZUNvbnRleHQ7XG5cbiAgcHVibGljIG9wdGlvbnM6IElPcHRpb25zO1xuICBwdWJsaWMgYXBwOiBBcHBsaWNhdGlvbjtcbiAgcHVibGljIHJvdXRlcjogUm91dGVyO1xuICBwdWJsaWMgY29udHJvbGxlcjogeyBbeDogc3RyaW5nXTogQmFzZUNvbnRleHQgfTtcbiAgcHVibGljIHNlcnZpY2U6IHsgW3g6IHN0cmluZ106IEJhc2VDb250ZXh0IH07XG5cbiAgLyoqXG4gICAqIEBjb25zdHJ1Y3RvclxuICAgKiBAcGFyYW0gIG9wdGlvbnMgb3B0aW9uc1xuICAgKiBAcGFyYW0gW29wdGlvbnMucm9vdERpcl0gdGhlIGRpcmVjdG9yeSBvZiB1c2VyIGFwcGxpY2F0aW9uXG4gICAqIEBwYXJhbSBbb3B0aW9ucy5wb3J0XSB0aGUgcG9ydCBvZiB1c2VyIGFwcGxpY3Rpb24gd2lsbCBydW4gYXRcbiAgICovXG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogSU9wdGlvbnMpIHtcbiAgICBhc3NlcnQoXG4gICAgICB0eXBlb2Ygb3B0aW9ucy5yb290RGlyID09PSAnc3RyaW5nJyxcbiAgICAgICdvcHRpb25zLnJvb3REaXIgY29uZmlnIGVycm9yIScsXG4gICAgKTtcblxuICAgIC8qKlxuICAgICAqIHVzZXIgb3B0aW9uc1xuICAgICAqXG4gICAgICogQHNpbmNlIDAuMS4wXG4gICAgICovXG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcblxuICAgIC8qKlxuICAgICAqIEtvYSBhcHBsaWN0aW9uIGluc3RhbmNlXG4gICAgICpcbiAgICAgKiBAc2luY2UgMC4xLjBcbiAgICAgKi9cbiAgICB0aGlzLmFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuXG4gICAgLyoqXG4gICAgICogbWFpdXMgcm91dGVyXG4gICAgICpcbiAgICAgKiBAc2luY2UgMC4xLjBcbiAgICAgKi9cbiAgICB0aGlzLnJvdXRlciA9IG5ldyBSb3V0ZXIoe30sIHRoaXMpO1xuXG4gICAgLyoqXG4gICAgICogY29udHJvbGxlciBpbnN0YW5jZXMgY29sbGVjdGlvblxuICAgICAqXG4gICAgICogQHNpbmNlIDAuMS4wXG4gICAgICovXG4gICAgdGhpcy5jb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVyTG9hZGVyLmdldEludGFuY2VzQ29sPEJhc2VDb250ZXh0PigpO1xuXG4gICAgZGVidWcoJyVvICVvJywgJ3RoaXMuY29udHJvbGxlcicsIHRoaXMuY29udHJvbGxlcik7XG5cbiAgICAvKipcbiAgICAgKiBzZXJ2aWNlIGluc3RhbmNlcyBjb2xsZWN0aW9uXG4gICAgICpcbiAgICAgKiBAc2luY2UgMC4xLjBcbiAgICAgKi9cbiAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2VMb2FkZXIuZ2V0SW50YW5jZXNDb2woKTtcblxuICAgIGRlYnVnKCclbyAlbycsICd0aGlzLnNlcnZpY2UnLCB0aGlzLnNlcnZpY2UpO1xuXG4gICAgdGhpcy5zZXRDb250cm9sbGVyQW5kU2VydmljZVByb3BzKCk7XG5cbiAgICB0aGlzLnVzZU1pZGRsZXdhcmUoKTtcblxuICAgIGRlYnVnKFxuICAgICAgJyVvICVvICVvJyxcbiAgICAgICdtaWRkbGV3YXJlJyxcbiAgICAgIHRoaXMubWlkZGxld2FyZSxcbiAgICAgIHRoaXMuYWZ0ZXJSb3V0ZXJNaWRkbGV3YXJlLFxuICAgICk7XG5cbiAgICB0aGlzLnVzZVN0YXRpYygpO1xuICAgIHRoaXMudXNlUm91dGVyKCk7XG4gICAgdGhpcy51c2VBZnRlclJvdXRlck1pZGRsZXdhcmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBjb250cm9sbGVyIGxvYWRlciwgYW5kIHRoZSBsb2FkZXIgaXMgYSBzaW5nbGUgaW5zdGFuY2UuXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqL1xuXG4gIGdldCBjb250cm9sbGVyTG9hZGVyKCk6IENvbnRyb2xsZXJMb2FkZXIge1xuICAgIGlmICh0aGlzW0NPTlRST0xMRVJfTE9BREVSXSkge1xuICAgICAgcmV0dXJuIHRoaXNbQ09OVFJPTExFUl9MT0FERVJdO1xuICAgIH1cblxuICAgIHRoaXNbQ09OVFJPTExFUl9MT0FERVJdID0gbmV3IENvbnRyb2xsZXJMb2FkZXIoe1xuICAgICAgcGF0aDogcGF0aC5qb2luKHRoaXMub3B0aW9ucy5yb290RGlyLCAnY29udHJvbGxlcicpLFxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzW0NPTlRST0xMRVJfTE9BREVSXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBzZXJ2aWNlIGxvYWRlciwgYW5kIHRoZSBsb2FkZXIgaXMgYSBzaW5nbGUgaW5zdGFuY2UuXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqL1xuXG4gIGdldCBzZXJ2aWNlTG9hZGVyKCk6IFNlcnZpY2VMb2FkZXIge1xuICAgIGlmICh0aGlzW1NFUlZJQ0VfTE9BREVSXSkge1xuICAgICAgcmV0dXJuIHRoaXNbU0VSVklDRV9MT0FERVJdO1xuICAgIH1cblxuICAgIHRoaXNbU0VSVklDRV9MT0FERVJdID0gbmV3IFNlcnZpY2VMb2FkZXIoe1xuICAgICAgcGF0aDogcGF0aC5qb2luKHRoaXMub3B0aW9ucy5yb290RGlyLCAnc2VydmljZScpLFxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzW1NFUlZJQ0VfTE9BREVSXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNaWRkbGV3YXJlTG9hZGVyIGluc3RhbmNlXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqL1xuXG4gIGdldCBtaWRkbGV3YXJlTG9hZGVyKCk6IE1pZGRsZXdhcmVMb2FkZXIge1xuICAgIGlmICh0aGlzW01JRERMRVdBUkVfTE9BREVSXSkge1xuICAgICAgcmV0dXJuIHRoaXNbTUlERExFV0FSRV9MT0FERVJdO1xuICAgIH1cblxuICAgIHRoaXNbTUlERExFV0FSRV9MT0FERVJdID0gbmV3IE1pZGRsZXdhcmVMb2FkZXIodGhpcy5vcHRpb25zKTtcbiAgICByZXR1cm4gdGhpc1tNSURETEVXQVJFX0xPQURFUl07XG4gIH1cblxuICAvKipcbiAgICogQ29udHJvbGxlciBhbmQgU2VydmljZSBpbnN0YW5jZXMgd2lsbCBiaW5kIGNvbnRyb2xsZXIgYW5kIHNlcnZpY2VcbiAgICogaW4gdGhlaXIgY29udGV4dC5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICovXG5cbiAgcHVibGljIHNldENvbnRyb2xsZXJBbmRTZXJ2aWNlUHJvcHMoKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXModGhpcy5jb250cm9sbGVyKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICB0aGlzLmNvbnRyb2xsZXJba2V5XS5iaW5kQ29udHJvbGxlcih0aGlzLmNvbnRyb2xsZXIpO1xuICAgICAgdGhpcy5jb250cm9sbGVyW2tleV0uYmluZFNlcnZpY2UodGhpcy5zZXJ2aWNlKTtcbiAgICB9KTtcbiAgICBPYmplY3Qua2V5cyh0aGlzLnNlcnZpY2UpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIHRoaXMuc2VydmljZVtrZXldLmJpbmRDb250cm9sbGVyKHRoaXMuY29udHJvbGxlcik7XG4gICAgICB0aGlzLnNlcnZpY2Vba2V5XS5iaW5kU2VydmljZSh0aGlzLnNlcnZpY2UpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgdXNlcidzIG1pZGRsZXdhcmUgdGhhdCB0aGUgcHJvcGVydHkgJ2FmdGVyUm91dGVyJyBpcyBmYWxzZS5cbiAgICogVGhlIHByb3BlcnR5XG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqL1xuXG4gIHB1YmxpYyB1c2VNaWRkbGV3YXJlKCk6IHZvaWQge1xuICAgIHRoaXMubWlkZGxld2FyZS5mb3JFYWNoKGZuID0+IHtcbiAgICAgIHRoaXMuYXBwLnVzZShmbik7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTG9hZCB1c2VyJ3MgbWlkZGxld2FyZSB0aGF0IHRoZSBwcm9wZXJ0eSAnYWZ0ZXJSb3V0ZXInIGlzIHRydWUuXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqL1xuXG4gIHB1YmxpYyB1c2VBZnRlclJvdXRlck1pZGRsZXdhcmUoKTogdm9pZCB7XG4gICAgdGhpcy5hZnRlclJvdXRlck1pZGRsZXdhcmUuZm9yRWFjaChmbiA9PiB7XG4gICAgICB0aGlzLmFwcC51c2UoZm4pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIEBzaW5jZSAwLjEuMFxuICAgKi9cblxuICBwdWJsaWMgdXNlU3RhdGljKCk6IHZvaWQge1xuICAgIGNvbnN0IHB1YmxpY1BhdGggPSBwYXRoLmpvaW4odGhpcy5vcHRpb25zLnJvb3REaXIsICdwdWJsaWMnKTtcblxuICAgIHRyeSB7XG4gICAgICBmcy5yZWFkZGlyU3luYyhwdWJsaWNQYXRoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hcHAudXNlKG1haXVzU3RhdGljKHB1YmxpY1BhdGgsIHRoaXMudXNlckNvbmZpZy5zdGF0aWMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAc2luY2UgMC4xLjBcbiAgICovXG5cbiAgcHVibGljIHVzZVJvdXRlcigpOiB2b2lkIHtcbiAgICByZXF1aXJlKHBhdGguam9pbih0aGlzLm9wdGlvbnMucm9vdERpciwgJ3JvdXRlci5qcycpKSh7XG4gICAgICBjb250cm9sbGVyOiB0aGlzLmNvbnRyb2xsZXIsXG4gICAgICByb3V0ZXI6IHRoaXMucm91dGVyLFxuICAgIH0pO1xuICAgIHRoaXMuYXBwLnVzZSh0aGlzLnJvdXRlci5yb3V0ZXMoKSk7XG4gIH1cblxuICAvKipcbiAgICogdGhlIG1pZGRsZXdhcmVzIHdpdGhvdXQgYWZ0ZXJSb3V0ZXJNaWRkbGV3YXJlLlxuICAgKi9cblxuICBnZXQgbWlkZGxld2FyZSgpIHtcbiAgICByZXR1cm4gdGhpcy5taWRkbGV3YXJlTG9hZGVyLmdldE1pZGRsZXdlcmEoKS5taWRkbGV3YXJlO1xuICB9XG5cbiAgLyoqXG4gICAqIHRoZSBhZnRlclJvdXRlck1pZGRsZXdhcmVzXG4gICAqL1xuXG4gIGdldCBhZnRlclJvdXRlck1pZGRsZXdhcmUoKSB7XG4gICAgcmV0dXJuIHRoaXMubWlkZGxld2FyZUxvYWRlci5nZXRNaWRkbGV3ZXJhKCkuYWZ0ZXJSb3V0ZXJNaWRkbGV3YXJlO1xuICB9XG5cbiAgLyoqXG4gICAqIHVzZXIgY29uZmlnXG4gICAqXG4gICAqIEBzaW5jZSAwLjEuMFxuICAgKi9cblxuICBnZXQgdXNlckNvbmZpZygpOiBvYmplY3Qge1xuICAgIGlmICh0aGlzW1VTRVJfQ09ORklHXSkge1xuICAgICAgcmV0dXJuIHRoaXNbVVNFUl9DT05GSUddO1xuICAgIH1cblxuICAgIHRoaXNbVVNFUl9DT05GSUddID0gbmV3IFVzZXJDb25maWdMb2FkZXIodGhpcykuY29uZmlnO1xuICAgIHJldHVybiB0aGlzW1VTRVJfQ09ORklHXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gYXBwY2F0aW9uIGF0IHBvcnRcbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHBvcnQgcnVuIGFwcCBhdCB0aGUgcG9ydFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICpcbiAgICogQHNpbmNlIDAuMS4wXG4gICAqL1xuXG4gIHB1YmxpYyBsaXN0ZW4ocG9ydCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGFzc2VydChcbiAgICAgIHR5cGVvZiBwb3J0ID09PSAnbnVtYmVyJyxcbiAgICAgICdNYWl1cy5wcm90b3R5cGUubGlzdGVuKHBvcnQpLCBwb3J0IG11c3QgYmUgYSBudW1iZXInLFxuICAgICk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICB0aGlzLmFwcC5saXN0ZW4ocG9ydCwgKCkgPT4gcmVzb2x2ZSgpKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBNYWl1cztcblxubW9kdWxlLmV4cG9ydHMgPSBNYWl1cztcbiJdfQ==
